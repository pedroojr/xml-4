name: Provision API Domain (Nginx + SSL)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Create provision script
        run: |
          cat > provision-api.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸš€ Starting API provision..."
          
          # ConfiguraÃ§Ãµes fixas
          API_DOMAIN="api.xml.lojasrealce.shop"
          API_PORT="3001"
          CERTBOT_EMAIL="pedrojr.xp@gmail.com"
          ALLOWED1="https://xml.lojasrealce.shop"
          ALLOWED2="https://www.xml.lojasrealce.shop"
          
          echo "ðŸ“‹ Config: $API_DOMAIN -> port $API_PORT"
          
          # Atualizar sistema
          echo "ðŸ“¦ Updating system packages..."
          sudo apt-get update -y
          sudo apt-get install -y nginx certbot python3-certbot-nginx
          
          # Nginx server block
          echo "ðŸ”§ Configuring Nginx..."
          CONF="/etc/nginx/sites-available/${API_DOMAIN}"
          sudo bash -lc "cat > '$CONF' <<'NGINX'
          server {
            listen 80;
            server_name ${API_DOMAIN};
            
            location / {
              proxy_pass http://127.0.0.1:${API_PORT};
              proxy_http_version 1.1;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
              proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$scheme;
            }
          }
          NGINX"
          
          sudo ln -sf "$CONF" "/etc/nginx/sites-enabled/${API_DOMAIN}"
          sudo nginx -t
          sudo systemctl reload nginx
          echo "âœ… Nginx configured and reloaded"
          
          # Issue SSL certificate
          echo "ðŸ”’ Issuing SSL certificate..."
          sudo certbot --nginx -d "$API_DOMAIN" -m "$CERTBOT_EMAIL" --agree-tos --non-interactive --redirect || true
          sudo systemctl reload nginx || true
          echo "âœ… SSL certificate issued"
          
          # Configure backend CORS
          echo "ðŸ”§ Configuring backend CORS..."
          ENV_FILE="/var/www/api/.env"
          sudo mkdir -p /var/www/api
          sudo touch "$ENV_FILE"
          sudo bash -lc "grep -q '^ALLOWED_ORIGINS=' '$ENV_FILE' && sed -i 's#^ALLOWED_ORIGINS=.*#ALLOWED_ORIGINS=${ALLOWED1},${ALLOWED2}#' '$ENV_FILE' || echo ALLOWED_ORIGINS=${ALLOWED1},${ALLOWED2} >> '$ENV_FILE'"
          
          # Restart backend if managed by PM2
          if command -v pm2 >/dev/null 2>&1; then
            echo "ðŸ”„ Restarting PM2 backend..."
            pm2 restart xml-importer-api || true
            pm2 save || true
          else
            echo "âš ï¸ PM2 not found, backend restart skipped"
          fi
          
          echo "ðŸŽ‰ Provision completed for ${API_DOMAIN} -> http://127.0.0.1:${API_PORT}"
          echo "ðŸŒ Test: https://${API_DOMAIN}/api/status"
          
          # Marcar como concluÃ­do
          echo "$(date): API provision completed successfully" >> /tmp/provision-api.log
          EOF

      - name: Upload provision script
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "provision-api.sh"
          target: "/tmp/provision-api.sh"
          strip_components: 0

      - name: Create execution trigger
        run: |
          echo "Creating execution trigger..."
          echo "$(date): API provision requested" > provision-trigger.txt

      - name: Upload execution trigger
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "provision-trigger.txt"
          target: "/tmp/provision-trigger.txt"
          strip_components: 0

      - name: Provision status
        run: |
          echo "âœ… Provision script uploaded successfully!"
          echo "ðŸ“‹ Next steps:"
          echo "1. SSH to server: ssh root@82.29.58.242"
          echo "2. Execute: chmod +x /tmp/provision-api.sh && /tmp/provision-api.sh"
          echo "3. Or monitor: tail -f /tmp/provision-api.log"


