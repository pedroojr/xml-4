name: Provision API Domain (Nginx + SSL)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          echo "Checking secrets..."
          for v in SFTP_HOST SFTP_PORT SFTP_USERNAME SFTP_PASSWORD; do
            if [ -z "${!v}" ]; then 
              echo "‚ùå Missing secret: $v" >&2
              exit 1
            else
              echo "‚úÖ Secret $v is set"
            fi
          done
          echo "‚úÖ All required secrets are present"
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}

      - name: Create provision script
        run: |
          cat > provision-api.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "üöÄ Starting API provision..."
          
          # Configura√ß√µes fixas
          API_DOMAIN="api.xml.lojasrealce.shop"
          API_PORT="3001"
          CERTBOT_EMAIL="pedrojr.xp@gmail.com"
          ALLOWED1="https://xml.lojasrealce.shop"
          ALLOWED2="https://www.xml.lojasrealce.shop"
          
          echo "üìã Config: $API_DOMAIN -> port $API_PORT"
          
          # Atualizar sistema
          echo "üì¶ Updating system packages..."
          sudo apt-get update -y
          sudo apt-get install -y nginx certbot python3-certbot-nginx
          
          # Nginx server block
          echo "üîß Configuring Nginx..."
          CONF="/etc/nginx/sites-available/${API_DOMAIN}"
          sudo bash -lc "cat > '$CONF' <<'NGINX'
          server {
            listen 80;
            server_name ${API_DOMAIN};
            
            location / {
              proxy_pass http://127.0.0.1:${API_PORT};
              proxy_http_version 1.1;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
              proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$scheme;
            }
          }
          NGINX"
          
          sudo ln -sf "$CONF" "/etc/nginx/sites-enabled/${API_DOMAIN}"
          sudo nginx -t
          sudo systemctl reload nginx
          echo "‚úÖ Nginx configured and reloaded"
          
          # Issue SSL certificate
          echo "üîí Issuing SSL certificate..."
          sudo certbot --nginx -d "$API_DOMAIN" -m "$CERTBOT_EMAIL" --agree-tos --non-interactive --redirect || true
          sudo systemctl reload nginx || true
          echo "‚úÖ SSL certificate issued"
          
          # Configure backend CORS
          echo "üîß Configuring backend CORS..."
          ENV_FILE="/var/www/api/.env"
          sudo mkdir -p /var/www/api
          sudo touch "$ENV_FILE"
          sudo bash -lc "grep -q '^ALLOWED_ORIGINS=' '$ENV_FILE' && sed -i 's#^ALLOWED_ORIGINS=.*#ALLOWED_ORIGINS=${ALLOWED1},${ALLOWED2}#' '$ENV_FILE' || echo ALLOWED_ORIGINS=${ALLOWED1},${ALLOWED2} >> '$ENV_FILE'"
          
          # Restart backend if managed by PM2
          if command -v pm2 >/dev/null 2>&1; then
            echo "üîÑ Restarting PM2 backend..."
            pm2 restart xml-importer-api || true
            pm2 save || true
          else
            echo "‚ö†Ô∏è PM2 not found, backend restart skipped"
          fi
          
          echo "üéâ Provision completed for ${API_DOMAIN} -> http://127.0.0.1:${API_PORT}"
          echo "üåê Test: https://${API_DOMAIN}/api/status"
          EOF

      - name: Upload and execute provision script
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "provision-api.sh"
          target: "/tmp/provision-api.sh"
          strip_components: 0

      - name: Execute provision script
        run: |
          echo "Executing provision script on server..."
          # Usar expect para automatizar a execu√ß√£o SSH
          expect << 'EOF'
          spawn ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} ${{ secrets.SFTP_USERNAME }}@${{ secrets.SFTP_HOST }}
          expect "password:"
          send "${{ secrets.SFTP_PASSWORD }}\r"
          expect "$ "
          send "chmod +x /tmp/provision-api.sh\r"
          expect "$ "
          send "/tmp/provision-api.sh\r"
          expect "$ "
          send "exit\r"
          expect eof
          EOF
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}


